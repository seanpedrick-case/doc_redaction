name: Sync to Hugging Face hub Zero GPU
on:
  push:
    branches: [dev]

permissions:
  contents: read

jobs:
  sync-to-hub-zero-gpu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1      # Only get the latest state
          lfs: true           # Download actual LFS files so they can be pushed

      - name: Install Git LFS
        run: git lfs install

      - name: Recreate repo history (single-commit force push)
        run: |
          git config --global user.name "$HF_USERNAME"
          git config --global user.email "$HF_EMAIL"

          git remote add hf https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_REPO_ID_ZERO_GPU    

          # 1. Capture the commit message BEFORE switching branches
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Syncing commit message: $COMMIT_MSG"

          # 2. Create a fresh orphan branch (disconnects from history)
          git switch --orphan temp_branch
          
          # 3. Add all files currently in the working directory
          git add -A
          
          # 4. Commit using the captured message
          git commit -m "Sync: $COMMIT_MSG"

          # 5. Force push to main on Hugging Face
          git push --force hf temp_branch:main
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_EMAIL: ${{ secrets.HF_EMAIL }}
          HF_REPO_ID_ZERO_GPU: ${{ secrets.HF_REPO_ID_ZERO_GPU }}